<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todo App</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { max-width: 720px; margin: 40px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; }
    form { display: flex; gap: 8px; margin: 16px 0; }
    input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    button.primary { background: #4f46e5; color: #fff; }
    ul { list-style: none; padding: 0; margin: 16px 0; }
    li { display: flex; align-items: center; gap: 10px; padding: 10px 8px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; }
    li.done .title { text-decoration: line-through; opacity: .6; }
    .title { flex: 1; }
    .meta { color:#888; font-size: 12px; }
    .danger { background: #ef4444; color:#fff; }
    #status { min-height: 20px; color:#888; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Todo</h1>

  <form id="add-form">
    <input id="title" type="text" placeholder="Yeni görev..." autocomplete="off" />
    <button class="primary" type="submit">Ekle</button>
  </form>

  <div id="status"></div>
  <ul id="list"></ul>

  <script>
    const API = "/api/todos";
    const $ = (sel) => document.querySelector(sel);
    const listEl = $("#list");
    const statusEl = $("#status");
    const formEl = $("#add-form");
    const titleEl = $("#title");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    async function loadTodos() {
      setStatus("Yükleniyor...");
      try {
        const res = await fetch(API);
        if (!res.ok) throw new Error("Liste alınamadı");
        const todos = await res.json();
        renderTodos(todos);
        setStatus(todos.length ? "" : "Henüz görev yok.");
      } catch (e) {
        console.error(e);
        setStatus("Hata: " + e.message);
      }
    }

    function renderTodos(todos) {
      listEl.innerHTML = "";
      for (const t of todos) {
        const li = document.createElement("li");
        li.dataset.id = t.id;
        if (t.done) li.classList.add("done");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = t.done;
        cb.onchange = () => toggleDone(t.id, cb.checked);

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = t.title;

        const meta = document.createElement("div");
        meta.className = "meta";
        if (t.created_at) meta.textContent = new Date(t.created_at).toLocaleString();

        const del = document.createElement("button");
        del.className = "danger";
        del.textContent = "Sil";
        del.onclick = () => deleteTodo(t.id);

        li.append(cb, title, meta, del);
        listEl.appendChild(li);
      }
    }

    async function addTodo(e) {
      e.preventDefault();
      const title = titleEl.value.trim();
      if (!title) return setStatus("Başlık boş olamaz.");
      setStatus("Ekleniyor...");
      try {
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title })
        });
        if (!res.ok) throw new Error("Ekleme başarısız");
        titleEl.value = "";
        await loadTodos(); // yeniden listele
        setStatus("Eklendi.");
      } catch (e) {
        console.error(e);
        setStatus("Hata: " + e.message);
      }
    }

    async function toggleDone(id, done) {
      setStatus("Güncelleniyor...");
      try {
        const res = await fetch(`${API}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ done })
        });
        if (!res.ok) throw new Error("Güncelleme başarısız");
        await loadTodos();
        setStatus("Güncellendi.");
      } catch (e) {
        console.error(e);
        setStatus("Hata: " + e.message);
      }
    }

    async function deleteTodo(id) {
      if (!confirm("Silinsin mi?")) return;
      setStatus("Siliniyor...");
      try {
        const res = await fetch(`${API}/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Silme başarısız");
        await loadTodos();
        setStatus("Silindi.");
      } catch (e) {
        console.error(e);
        setStatus("Hata: " + e.message);
      }
    }

    formEl.addEventListener("submit", addTodo);
    window.addEventListener("load", loadTodos);
  </script>
</body>
</html>
